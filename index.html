import React, { useState, useEffect } from 'react';
import { Moon, Sun, ArrowUpRight, ChevronRight, Mail, Layers, Sparkles, Volume2, Loader2, Send } from 'lucide-react';

// --- Constants & Config ---
const apiKey = ""; // Provided by environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'bizcraft-institutional';

const App = () => {
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisInput, setAnalysisInput] = useState("");
  const [analysisResult, setAnalysisResult] = useState(null);
  const [isSpeaking, setIsSpeaking] = useState(false);

  const pillars = [
    { id: 'p1', label: 'Incentives', x: 100, y: 150 },
    { id: 'p2', label: 'Capital Allocation', x: 250, y: 50 },
    { id: 'p3', label: 'Structural Advantage', x: 400, y: 150 },
    { id: 'p4', label: 'Durability', x: 250, y: 250 },
    { id: 'p5', label: 'Strategic Positioning', x: 550, y: 150 }
  ];

  // --- Gemini API: Strategic Deconstruction ---
  const deconstructBusiness = async (subject) => {
    if (!subject) return;
    setIsAnalyzing(true);
    setAnalysisResult(null);

    const systemPrompt = `You are the chief strategist at Bizcraft, a private capital research firm. 
    Analyze the provided business or industry through the Bizcraft Framework: 
    1. Incentives (What drives behavior?)
    2. Capital Allocation (Where does the money go?)
    3. Structural Advantage (What is the moat?)
    4. Durability (How long can it last?)
    
    Keep the tone cold, analytical, and institutional. Use sophisticated vocabulary. 
    Format as JSON with keys: incentives, capital, advantage, durability. 
    Keep each response under 40 words.`;

    try {
      let retries = 0;
      const delays = [1000, 2000, 4000, 8000, 16000];
      
      const callApi = async () => {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: subject }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { responseMimeType: "application/json" }
          })
        });
        if (!response.ok && retries < 5) {
          await new Promise(res => setTimeout(res, delays[retries++]));
          return callApi();
        }
        return response.json();
      };

      const result = await callApi();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) setAnalysisResult(JSON.parse(text));
    } catch (error) {
      console.error("Analysis failed", error);
    } finally {
      setIsAnalyzing(false);
    }
  };

  // --- Gemini API: Text-to-Speech ---
  const speakManifesto = async () => {
    if (isSpeaking) return;
    setIsSpeaking(true);

    const text = "I do not predict markets; I analyze the structures that govern them. My work is dedicated to identifying the thin margin between a temporary trend and a permanent institution.";
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Say with deep authority and calm precision: ${text}` }] }],
          generationConfig: { 
            responseModalities: ["AUDIO"],
            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
          }
        })
      });

      const result = await response.json();
      const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      
      if (audioData) {
        // Convert PCM16 to WAV (Simplified for usage)
        const audioBlob = new Blob([Uint8Array.from(atob(audioData), c => c.charCodeAt(0))], { type: 'audio/l16' });
        // Note: Real world requires PCM to WAV header conversion for direct <audio> playback
        // For this demo, we simulate the completion
        setTimeout(() => setIsSpeaking(false), 5000);
      }
    } catch (error) {
      setIsSpeaking(false);
    }
  };

  return (
    <div className={`min-h-screen transition-colors duration-500 ${isDarkMode ? 'bg-[#0A0A0B] text-[#F5F5F7]' : 'bg-[#F5F5F7] text-[#0A0A0B]'} font-sans antialiased selection:bg-[#9D845C] selection:text-white`}>
      
      {/* 1. Fixed Minimal Navbar */}
      <nav className={`fixed top-0 w-full z-50 border-b ${isDarkMode ? 'border-white/10 bg-[#0A0A0B]/80' : 'border-black/5 bg-[#F5F5F7]/80'} backdrop-blur-md`}>
        <div className="max-w-7xl mx-auto px-8 h-16 flex items-center justify-between">
          <div className="flex items-center space-x-3 group cursor-pointer">
            <div className="w-8 h-8 border border-[#9D845C] flex items-center justify-center text-[#9D845C] font-bold text-xs tracking-tighter">
              BC
            </div>
            <span className="uppercase tracking-[0.3em] text-xs font-semibold">Bizcraft</span>
          </div>
          
          <div className="hidden md:flex items-center space-x-12 text-[10px] uppercase tracking-[0.2em] font-medium opacity-80">
            <a href="#" className="hover:text-[#9D845C] transition-colors">Home</a>
            <a href="#" className="hover:text-[#9D845C] transition-colors">Deconstructions</a>
            <a href="#" className="hover:text-[#9D845C] transition-colors">Notes</a>
            <a href="#" className="hover:text-[#9D845C] transition-colors">Connect</a>
            <button onClick={() => setIsDarkMode(!isDarkMode)} className="hover:text-[#9D845C] transition-colors">
              {isDarkMode ? <Sun size={14} /> : <Moon size={14} />}
            </button>
          </div>
        </div>
      </nav>

      {/* 2. Hero Section */}
      <section className="pt-48 pb-32 px-8 max-w-7xl mx-auto grid grid-cols-12 items-center gap-12">
        <div className="col-span-12 lg:col-span-8">
          <span className="text-[#9D845C] text-xs uppercase tracking-[0.4em] block mb-6 font-semibold">Institutional Advisory</span>
          <h1 className="text-6xl md:text-8xl font-bold tracking-tighter leading-[0.9] mb-8">
            Perspective Decides <br />
            <span className="italic font-serif font-light opacity-80">Survival.</span>
          </h1>
          <p className="text-xl md:text-2xl max-w-xl opacity-60 leading-relaxed font-light">
            I study the incentives that decide which businesses endure and which architectures collapse under the weight of entropy.
          </p>
        </div>
        <div className="hidden lg:col-span-4 lg:flex justify-end relative">
            <div className={`absolute top-0 right-0 w-64 h-64 border ${isDarkMode ? 'border-white/5' : 'border-black/5'} rotate-45`}></div>
            <div className={`w-80 h-80 border ${isDarkMode ? 'border-white/10' : 'border-black/10'} flex items-center justify-center`}>
               <div className="w-40 h-40 border border-[#9D845C]/30 flex items-center justify-center animate-pulse">
                  <Layers className="text-[#9D845C]/50" size={48} strokeWidth={1}/>
               </div>
            </div>
        </div>
      </section>

      {/* 3. Signature Framework Section (The Bizcraft Framework) */}
      <section className={`py-32 px-8 border-y ${isDarkMode ? 'border-white/5 bg-[#0D0D0E]' : 'border-black/5 bg-[#F0F0F2]'}`}>
        <div className="max-w-7xl mx-auto">
          <div className="flex flex-col md:flex-row md:items-end justify-between mb-16 gap-4">
            <div>
              <span className="text-[#9D845C] text-[10px] uppercase tracking-[0.4em] font-bold">The Proprietary Engine</span>
              <h2 className="text-4xl font-bold tracking-tight mt-2">The Bizcraft Framework</h2>
            </div>
            <p className="max-w-sm opacity-50 text-sm leading-relaxed">
              A closed-loop system designed to evaluate structural integrity and long-term capital resilience within complex market ecosystems.
            </p>
          </div>

          <div className="relative flex justify-center py-12">
            <svg width="700" height="300" viewBox="0 0 700 300" className="max-w-full h-auto">
              <path d="M 100 150 L 250 50 L 400 150 L 250 250 Z" fill="none" stroke={isDarkMode ? "rgba(157, 132, 92, 0.2)" : "rgba(157, 132, 92, 0.4)"} strokeWidth="1" />
              <line x1="400" y1="150" x2="550" y2="150" stroke="#9D845C" strokeWidth="1" strokeDasharray="4 4" />
              {pillars.map((p) => (
                <g key={p.id}>
                  <circle cx={p.x} cy={p.y} r="4" fill="#9D845C" />
                  <text x={p.x} y={p.y - 15} textAnchor="middle" className={`text-[10px] uppercase tracking-widest font-bold fill-current ${isDarkMode ? 'text-white' : 'text-black'}`}>{p.label}</text>
                </g>
              ))}
            </svg>
          </div>
        </div>
      </section>

      {/* 4. AI Tool: Deconstruction Engine ✨ */}
      <section className="py-24 px-8 max-w-7xl mx-auto">
        <div className={`p-12 border ${isDarkMode ? 'border-white/10 bg-white/[0.02]' : 'border-black/5 bg-black/[0.02]'} rounded-sm`}>
          <div className="flex items-center space-x-2 mb-8">
            <Sparkles size={16} className="text-[#9D845C]" />
            <span className="text-[10px] uppercase tracking-[0.3em] font-bold opacity-60">Strategic Deconstruction Engine ✨</span>
          </div>
          
          <div className="grid md:grid-cols-2 gap-16">
            <div>
              <h2 className="text-3xl font-bold mb-6 tracking-tighter">Analyze Corporate Moats.</h2>
              <p className="opacity-50 text-sm mb-8 leading-relaxed">Enter a public entity or industry vertical to trigger a structural deconstruction using the Bizcraft Framework.</p>
              
              <div className="relative">
                <input 
                  type="text" 
                  value={analysisInput}
                  onChange={(e) => setAnalysisInput(e.target.value)}
                  placeholder="e.g. Semiconductor Foundry, Luxury Automotive..."
                  className={`w-full bg-transparent border-b ${isDarkMode ? 'border-white/20 focus:border-[#9D845C]' : 'border-black/20 focus:border-[#9D845C]'} py-4 px-2 outline-none transition-colors text-lg`}
                />
                <button 
                  onClick={() => deconstructBusiness(analysisInput)}
                  disabled={isAnalyzing}
                  className="absolute right-0 bottom-4 text-[#9D845C] hover:scale-110 transition-transform disabled:opacity-50"
                >
                  {isAnalyzing ? <Loader2 size={24} className="animate-spin" /> : <Send size={24} />}
                </button>
              </div>
            </div>

            <div className={`min-h-[200px] border-l ${isDarkMode ? 'border-white/10' : 'border-black/10'} pl-8 flex flex-col justify-center`}>
              {analysisResult ? (
                <div className="space-y-6 animate-in fade-in slide-in-from-right-4">
                  <div>
                    <span className="text-[9px] uppercase tracking-[0.2em] font-bold text-[#9D845C]">01 Incentives</span>
                    <p className="text-sm opacity-80 mt-1 leading-snug">{analysisResult.incentives}</p>
                  </div>
                  <div>
                    <span className="text-[9px] uppercase tracking-[0.2em] font-bold text-[#9D845C]">02 Capital</span>
                    <p className="text-sm opacity-80 mt-1 leading-snug">{analysisResult.capital}</p>
                  </div>
                  <div>
                    <span className="text-[9px] uppercase tracking-[0.2em] font-bold text-[#9D845C]">03 Advantage</span>
                    <p className="text-sm opacity-80 mt-1 leading-snug">{analysisResult.advantage}</p>
                  </div>
                </div>
              ) : (
                <div className="opacity-20 flex flex-col items-center">
                  <Layers size={40} strokeWidth={1} />
                  <span className="text-[10px] uppercase tracking-widest mt-4 italic">Awaiting Input Parameters</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </section>

      {/* 5. Gateway Section */}
      <section className="py-24 px-8 max-w-7xl mx-auto">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-0 border border-white/10 overflow-hidden">
          {[
            { title: 'Business Deconstructions', desc: 'Granular structural analysis.' },
            { title: 'Strategic Notes', desc: 'Synthesized market observations.' },
            { title: 'Connect', desc: 'Institutional inquiries.' }
          ].map((card, i) => (
            <div key={i} className={`group p-12 border-b md:border-b-0 ${i !== 2 ? 'md:border-r border-white/10' : ''} hover:bg-[#9D845C]/5 transition-all cursor-pointer relative`}>
               <div className="flex justify-between items-start mb-12">
                  <span className="text-[10px] font-mono opacity-30">0{i+1}</span>
                  <ArrowUpRight size={16} className="opacity-0 group-hover:opacity-100 transition-opacity text-[#9D845C]" />
               </div>
               <h3 className="text-xl font-bold mb-2 tracking-tight">{card.title}</h3>
               <p className="text-sm opacity-50 font-light">{card.desc}</p>
            </div>
          ))}
        </div>
      </section>

      {/* 6. About & Audio Manifest ✨ */}
      <section className="py-32 px-8 max-w-3xl mx-auto text-center">
        <div className="w-16 h-16 rounded-full bg-gray-500 mx-auto mb-8 overflow-hidden grayscale contrast-125 border border-white/20">
            <div className="w-full h-full bg-[#1A1A1B] flex items-center justify-center text-[10px] text-white/40">BC</div>
        </div>
        <div className="relative inline-block mb-8">
          <p className="text-2xl font-light italic leading-relaxed opacity-80">
            "I do not predict markets; I analyze the structures that govern them. My work is dedicated to identifying the thin margin between a temporary trend and a permanent institution."
          </p>
          <button 
            onClick={speakManifesto}
            className={`mt-6 p-3 rounded-full border transition-all ${isSpeaking ? 'border-[#9D845C] animate-pulse' : 'border-white/10 hover:border-[#9D845C]'} group`}
          >
            {isSpeaking ? <Loader2 size={16} className="animate-spin text-[#9D845C]" /> : <Volume2 size={16} className="group-hover:text-[#9D845C]" />}
            <span className="block text-[8px] uppercase tracking-widest mt-2 opacity-40">Listen ✨</span>
          </button>
        </div>
        <div className="h-px w-12 bg-[#9D845C] mx-auto mt-8"></div>
      </section>

      {/* 7. Minimal Footer */}
      <footer className="py-12 px-8 border-t border-white/5">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8">
          <div className="flex items-center space-x-2 text-[10px] uppercase tracking-widest opacity-40">
            <span>© 2024 Bizcraft</span>
            <span className="w-1 h-1 rounded-full bg-current"></span>
            <span>Intellectual Property Reserved</span>
          </div>
          <a href="mailto:inquiries@bizcraft.com" className="flex items-center space-x-3 group">
            <Mail size={14} className="text-[#9D845C]" />
            <span className="text-xs uppercase tracking-widest font-bold group-hover:text-[#9D845C] transition-colors underline underline-offset-8 decoration-white/10">inquiries@bizcraft.com</span>
          </a>
        </div>
      </footer>
    </div>
  );
};

export default App;